import logging
from telegram.ext import ApplicationBuilder, CommandHandler
from .config import BOT_TOKEN
from .line_limit_file_handler import LineLimitFileHandler
from .plugins.start import start
from .plugins.info import info
from .plugins.sysinfo import sysinfo
from .plugins.modeminfo import modeminfo

def main() -> None:
    # Konfigurasi logging
    log_filename = '/usr/share/telegrambot/logs/bot.log'
    log_handler = LineLimitFileHandler(log_filename, max_lines=300, mode='a', encoding='utf-8')
    logging.basicConfig(
        level=logging.INFO,
        handlers=[log_handler],
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    logger = logging.getLogger(__name__)

    logger.info("Memulai bot...")

    # Buat Aplikasi dan berikan token bot Anda.
    application = ApplicationBuilder().token(BOT_TOKEN).build()

    # pada perintah yang berbeda - jawab di Telegram
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("info", info))
    application.add_handler(CommandHandler("sysinfo", sysinfo))
    application.add_handler(CommandHandler("modeminfo", modeminfo))

    # Set webhook
    application.bot.set_webhook(url="https://192.168.1.1/7323397448:AAEDTP8CrUCYuofwO0DLaYRvHBUtvPszjis")
    
    # Jalankan bot dengan webhook
    application.run_webhook(
        listen="0.0.0.0",
        port=8443,
        url_path="7323397448:AAEDTP8CrUCYuofwO0DLaYRvHBUtvPszjis",
        webhook_url="https://192.168.1.1/7323397448:AAEDTP8CrUCYuofwO0DLaYRvHBUtvPszjis"
    )

if __name__ == '__main__':
    main()